public class LeadBlacklistHandler {
    
    // API configuration
    private static final String API_BASE_URL = 'https://api.blacklistalliance.net/lookup';
    private static final String API_KEY = 'pXh4k4m9vt8vrAJ6DUND'; // Consider storing in Custom Metadata or Custom Settings
    
    public static void handleAfterInsert(List<Lead> newLeads) {
        System.debug('ğŸš€ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        System.debug('ğŸš€ BLACKLIST HANDLER: Starting Lead processing after insert');
        System.debug('ğŸš€ Total leads received: ' + newLeads.size());
        System.debug('ğŸš€ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        // Filter leads that have phone numbers and collect their IDs and phone numbers
        List<String> leadIds = new List<String>();
        List<String> phoneNumbers = new List<String>();
        
        Integer leadsWithPhone = 0;
        Integer leadsWithoutPhone = 0;
        
        for (Lead lead : newLeads) {
            if (String.isNotBlank(lead.Phone)) {
                leadIds.add(lead.Id);
                phoneNumbers.add(lead.Phone);
                leadsWithPhone++;
                System.debug('âœ… Lead with phone found - ID: ' + lead.Id + ' | Phone: ' + lead.Phone);
            } else {
                leadsWithoutPhone++;
                System.debug('âŒ Lead without phone skipped - ID: ' + lead.Id);
            }
        }
        
        System.debug('ğŸ“Š â•â•â• FILTERING SUMMARY â•â•â•');
        System.debug('ğŸ“Š Leads with phone numbers: ' + leadsWithPhone);
        System.debug('ğŸ“Š Leads without phone numbers: ' + leadsWithoutPhone);
        System.debug('ğŸ“Š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        if (!leadIds.isEmpty()) {
            System.debug('ğŸ”„ Sending ' + leadIds.size() + ' leads for async processing...');
            // Process API calls asynchronously to avoid governor limits
            processLeadsAsync(leadIds, phoneNumbers);
        } else {
            System.debug('âš ï¸ No leads with phone numbers found - skipping async processing');
        }
        
        System.debug('ğŸ BLACKLIST HANDLER: handleAfterInsert completed');
    }
    
    @future(callout=true)
    public static void processLeadsAsync(List<String> leadIds, List<String> phoneNumbers) {
        System.debug('âš¡ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        System.debug('âš¡ ASYNC PROCESSING: Starting future method execution');
        System.debug('âš¡ Processing ' + leadIds.size() + ' leads asynchronously');
        System.debug('âš¡ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        List<Lead> leadsToUpdate = new List<Lead>();
        Integer successfulApiCalls = 0;
        Integer failedApiCalls = 0;
        Integer goodNumbers = 0;
        Integer dncNumbers = 0;
        Integer leadsMarkedDNC = 0;
        
        for (Integer i = 0; i < leadIds.size(); i++) {
            String currentLeadId = leadIds[i];
            String currentPhone = phoneNumbers[i];
            
            System.debug('ğŸ” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            System.debug('ğŸ” Processing Lead #' + (i + 1) + ' of ' + leadIds.size());
            System.debug('ğŸ” Lead ID: ' + currentLeadId);
            System.debug('ğŸ” Phone: ' + currentPhone);
            System.debug('ğŸ” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            try {
                // Make API call for each lead
                BlacklistApiResponse response = callBlacklistApi(currentPhone);
                
                if (response != null) {
                    successfulApiCalls++;
                    System.debug('âœ… API call successful for lead: ' + currentLeadId);
                    System.debug('ğŸ“‹ Response status: ' + response.status);
                    System.debug('ğŸ“‹ Response message: ' + response.message);
                    
                    if (response.status == 'success') {
                        // Check if message is NOT 'Good' (indicating DNC status)
                        if (String.isNotBlank(response.message) && response.message != 'Good') {
                            dncNumbers++;
                            leadsMarkedDNC++;
                            System.debug('ğŸ”´ DNC NUMBER DETECTED! Message: ' + response.message);
                            System.debug('ğŸ”´ Lead ' + currentLeadId + ' will be updated to DNC status');
                            
                            // Log additional details if available
                            if (response.code != null && !response.code.isEmpty()) {
                                System.debug('ğŸ”´ DNC Codes: ' + String.join(response.code, ', '));
                            }
                            
                            Lead leadToUpdate = new Lead(
                                Id = currentLeadId,
                                Pre_Deal_Status__c = 'DNC'
                            );
                            leadsToUpdate.add(leadToUpdate);
                        } else if (response.message == 'Good') {
                            goodNumbers++;
                            System.debug('ğŸŸ¢ GOOD NUMBER - No action needed');
                        } else {
                            System.debug('ğŸŸ¡ UNKNOWN MESSAGE STATUS: ' + response.message);
                        }
                    } else {
                        System.debug('âŒ API returned non-success status: ' + response.status);
                    }
                } else {
                    failedApiCalls++;
                    System.debug('âŒ API call failed for lead: ' + currentLeadId);
                }
            } catch (Exception e) {
                failedApiCalls++;
                // Log error but don't fail the entire process
                System.debug('ğŸ’¥ â•â•â• EXCEPTION OCCURRED â•â•â•');
                System.debug('ğŸ’¥ Lead ID: ' + currentLeadId);
                System.debug('ğŸ’¥ Error: ' + e.getMessage());
                System.debug('ğŸ’¥ Line: ' + e.getLineNumber());
                System.debug('ğŸ’¥ Stack Trace: ' + e.getStackTraceString());
                System.debug('ğŸ’¥ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            }
        }
        
        System.debug('ğŸ“Š â•â•â• API PROCESSING SUMMARY â•â•â•');
        System.debug('ğŸ“Š Total leads processed: ' + leadIds.size());
        System.debug('ğŸ“Š Successful API calls: ' + successfulApiCalls);
        System.debug('ğŸ“Š Failed API calls: ' + failedApiCalls);
        System.debug('ğŸ“Š Good numbers: ' + goodNumbers);
        System.debug('ğŸ“Š DNC numbers: ' + dncNumbers);
        System.debug('ğŸ“Š Leads to mark as DNC: ' + leadsMarkedDNC);
        System.debug('ğŸ“Š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        // Update leads if any need to be updated
        if (!leadsToUpdate.isEmpty()) {
            System.debug('ğŸ’¾ Starting DML operation to update ' + leadsToUpdate.size() + ' leads...');
            try {
                update leadsToUpdate;
                System.debug('âœ… Successfully updated ' + leadsToUpdate.size() + ' leads to DNC status');
                
                // Log each updated lead
                for (Lead updatedLead : leadsToUpdate) {
                    System.debug('âœ… Lead updated - ID: ' + updatedLead.Id + ' | Status: DNC');
                }
            } catch (DmlException e) {
                System.debug('ğŸ’¥ â•â•â• DML EXCEPTION OCCURRED â•â•â•');
                System.debug('ğŸ’¥ Error updating leads: ' + e.getMessage());
                System.debug('ğŸ’¥ Number of failed records: ' + e.getNumDml());
                for (Integer j = 0; j < e.getNumDml(); j++) {
                    System.debug('ğŸ’¥ Failed record index: ' + e.getDmlIndex(j));
                    System.debug('ğŸ’¥ Failed record error: ' + e.getDmlMessage(j));
                }
                System.debug('ğŸ’¥ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            }
        } else {
            System.debug('â„¹ï¸ No leads need to be updated');
        }
        
        System.debug('ğŸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        System.debug('ğŸ ASYNC PROCESSING: Future method execution completed');
        System.debug('ğŸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    }
    
    private static BlacklistApiResponse callBlacklistApi(String phoneNumber) {
        System.debug('ğŸŒ â•â•â• API CALL STARTING â•â•â•');
        System.debug('ğŸŒ Original phone number: ' + phoneNumber);
        
        // Clean phone number (remove non-digits)
        String cleanPhone = phoneNumber.replaceAll('[^0-9]', '');
        System.debug('ğŸŒ Cleaned phone number: ' + cleanPhone);
        
        // Construct API URL
        String apiUrl = API_BASE_URL + '?key=' + API_KEY + '&phone=' + EncodingUtil.urlEncode(cleanPhone, 'UTF-8');
        System.debug('ğŸŒ API URL: ' + apiUrl.replace(API_KEY, '***HIDDEN***')); // Hide API key in logs
        
        Http http = new Http();
        HttpRequest request = new HttpRequest();
        request.setEndpoint(apiUrl);
        request.setMethod('GET');
        request.setHeader('Accept', 'application/json');
        request.setTimeout(10000); // 10 second timeout
        
        System.debug('ğŸŒ Request configured:');
        System.debug('ğŸŒ   Method: GET');
        System.debug('ğŸŒ   Timeout: 10000ms');
        System.debug('ğŸŒ   Accept: application/json');
        
        try {
            System.debug('ğŸŒ Sending HTTP request...');
            Long startTime = System.currentTimeMillis();
            
            HttpResponse response = http.send(request);
            
            Long endTime = System.currentTimeMillis();
            Long responseTime = endTime - startTime;
            
            System.debug('ğŸŒ HTTP response received in ' + responseTime + 'ms');
            System.debug('ğŸŒ Response status code: ' + response.getStatusCode());
            System.debug('ğŸŒ Response status: ' + response.getStatus());
            
            if (response.getStatusCode() == 200) {
                String responseBody = response.getBody();
                System.debug('ğŸŒ Response body length: ' + responseBody.length() + ' characters');
                System.debug('ğŸŒ Response body: ' + responseBody);
                
                try {
                    BlacklistApiResponse apiResponse = (BlacklistApiResponse) JSON.deserialize(responseBody, BlacklistApiResponse.class);
                    System.debug('âœ… JSON deserialization successful');
                    System.debug('âœ… Parsed response status: ' + apiResponse.status);
                    System.debug('âœ… Parsed response message: ' + apiResponse.message);
                    
                    if (apiResponse.code != null && !apiResponse.code.isEmpty()) {
                        System.debug('âœ… DNC codes found: ' + String.join(apiResponse.code, ', '));
                    }
                    
                    System.debug('ğŸŒ â•â•â• API CALL SUCCESS â•â•â•');
                    return apiResponse;
                } catch (JSONException je) {
                    System.debug('ğŸ’¥ JSON deserialization failed: ' + je.getMessage());
                    System.debug('ğŸ’¥ Raw response: ' + responseBody);
                    System.debug('ğŸŒ â•â•â• API CALL FAILED â•â•â•');
                    return null;
                }
            } else {
                System.debug('âŒ API call failed with non-200 status');
                System.debug('âŒ Status Code: ' + response.getStatusCode());
                System.debug('âŒ Status: ' + response.getStatus());
                System.debug('âŒ Response Body: ' + response.getBody());
                System.debug('ğŸŒ â•â•â• API CALL FAILED â•â•â•');
                return null;
            }
        } catch (CalloutException ce) {
            System.debug('ğŸ’¥ â•â•â• CALLOUT EXCEPTION â•â•â•');
            System.debug('ğŸ’¥ Callout exception: ' + ce.getMessage());
            System.debug('ğŸ’¥ Exception type: ' + ce.getTypeName());
            System.debug('ğŸ’¥ Stack trace: ' + ce.getStackTraceString());
            System.debug('ğŸŒ â•â•â• API CALL FAILED â•â•â•');
            return null;
        } catch (Exception e) {
            System.debug('ğŸ’¥ â•â•â• GENERAL EXCEPTION â•â•â•');
            System.debug('ğŸ’¥ General exception during API call: ' + e.getMessage());
            System.debug('ğŸ’¥ Exception type: ' + e.getTypeName());
            System.debug('ğŸ’¥ Line number: ' + e.getLineNumber());
            System.debug('ğŸ’¥ Stack trace: ' + e.getStackTraceString());
            System.debug('ğŸŒ â•â•â• API CALL FAILED â•â•â•');
            return null;
        }
    }
    
    // Wrapper classes for API response
    public class BlacklistApiResponse {
        public String sid { get; set; }
        public String status { get; set; }
        public String message { get; set; }
        public List<String> code { get; set; } // Updated to List<String> for multiple codes
        public Long offset { get; set; }
        public String phone { get; set; }
        public Integer results { get; set; }
        public Integer timeValue { get; set; } // Changed from 'time' to avoid reserved word
        public CarrierInfo carrier { get; set; }
        public Boolean scrubs { get; set; }
    }
    
    public class CarrierInfo {
        public String did { get; set; }
        public String carrierType { get; set; } // Changed from 'type' to avoid reserved word
        public String name { get; set; }
        public String state { get; set; }
        public String ratecenter { get; set; }
        public String country { get; set; }
        public String clli { get; set; }
        public String lata { get; set; }
        public String wireless { get; set; }
        public String lrn { get; set; }
        public String npa { get; set; }
        public String nxx { get; set; }
        public String nxxx { get; set; }
        public String ocn { get; set; }
        public String port_type { get; set; }
    }
}